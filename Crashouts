-- NX2 — تعديل نهائي: شريط علوي أصفر، زر شيل القائمة فوق السكربت، عنوان NX2 فوق START، تحميل 1.5s، واجهة غير قابلة للسحب، دوائر الأيم قابلة للسحب، ESP أخضر، وخط أيم أحمر عند الاستهداف
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local Camera = workspace.CurrentCamera

local player = Players.LocalPlayer

-- حماية بسيطة فقط للعرض
if not getgenv then
    print("NX2: Protection Active")
end

-- إزالة أي واجهة قديمة
if CoreGui:FindFirstChild("NX2_Carshoot") then
    CoreGui.NX2_Carshoot:Destroy()
end

-- إنشاء الـ ScreenGui
local sg = Instance.new("ScreenGui", CoreGui)
sg.Name = "NX2_Carshoot"
sg.ResetOnSpawn = false
sg.DisplayOrder = 9999

-- حالات / اتصالات للحذف لاحقاً
local connections = {}
local espGuis = {} -- map player -> BillboardGui

-- حالات التحكم
local sOn, jOn, nOn = false, false, false

-- حفظ القيم الافتراضية (لإعادتها عند التنظيف)
local defaultWalkSpeed = 16
local defaultJumpPower = 50
local function cacheDefaults()
    if player.Character and player.Character:FindFirstChildOfClass("Humanoid") then
        local hum = player.Character:FindFirstChildOfClass("Humanoid")
        defaultWalkSpeed = hum.WalkSpeed or defaultWalkSpeed
        if hum.JumpPower and hum.UseJumpPower then
            defaultJumpPower = hum.JumpPower or defaultJumpPower
        else
            defaultJumpPower = hum.JumpPower or hum.JumpHeight or defaultJumpPower
        end
    end
end
cacheDefaults()

-- ---------------- شريط علوي ثابت (يظهر دائماً) ----------------
local topBar = Instance.new("Frame", sg)
topBar.Name = "NX2_TopBar"
topBar.Size = UDim2.new(1, 0, 0, 34)
topBar.Position = UDim2.new(0, 0, 0, 0)
topBar.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
topBar.ZIndex = 10000
topBar.BorderSizePixel = 0

local topLabel = Instance.new("TextLabel", topBar)
topLabel.Name = "Label"
topLabel.Size = UDim2.new(0, 120, 1, 0)
topLabel.Position = UDim2.new(0, 8, 0, 0)
topLabel.BackgroundTransparency = 1
topLabel.Text = "NX2"
topLabel.TextColor3 = Color3.fromRGB(255, 255, 0) -- صفراء كما طلبت
topLabel.TextScaled = true
topLabel.Font = Enum.Font.SourceSansBold
topLabel.TextXAlignment = Enum.TextXAlignment.Left
topLabel.ZIndex = 10001

-- زر شيل القائمة (يوجد فوق السكربت بجانب NX2)
local topRemoveBtn = Instance.new("TextButton", topBar)
topRemoveBtn.Name = "TopRemove"
topRemoveBtn.Size = UDim2.new(0, 110, 1, 0)
topRemoveBtn.Position = UDim2.new(0, 140, 0, 0)
topRemoveBtn.Text = "شيل القائمة"
topRemoveBtn.TextColor3 = Color3.fromRGB(255,255,255)
topRemoveBtn.BackgroundTransparency = 1
topRemoveBtn.Font = Enum.Font.SourceSans
topRemoveBtn.TextSize = 16
topRemoveBtn.ZIndex = 10002

-- زر إظهار/إخفاء الواجهة على الشريط (محفوظ)
local toggleBtn = Instance.new("TextButton", topBar)
toggleBtn.Name = "Toggle"
toggleBtn.Size = UDim2.new(0, 60, 1, 0)
toggleBtn.Position = UDim2.new(1, -60, 0, 0)
toggleBtn.Text = "فتح"
toggleBtn.TextColor3 = Color3.fromRGB(255,255,255)
toggleBtn.BackgroundTransparency = 1
toggleBtn.Font = Enum.Font.SourceSans
toggleBtn.TextSize = 18
toggleBtn.ZIndex = 10002

-- زر خروج نهائي
local closeBtn = Instance.new("TextButton", topBar)
closeBtn.Name = "Close"
closeBtn.Size = UDim2.new(0, 60, 1, 0)
closeBtn.Position = UDim2.new(1, -140, 0, 0)
closeBtn.Text = "خروج"
closeBtn.TextColor3 = Color3.fromRGB(255, 100, 100)
closeBtn.BackgroundTransparency = 1
closeBtn.Font = Enum.Font.SourceSans
closeBtn.TextSize = 18
closeBtn.ZIndex = 10002

-- --------- لافتة بداية NX2 تظهر لبضع ثواني ---------
local splash = Instance.new("Frame", sg)
splash.Name = "Splash"
splash.Size = UDim2.new(0, 360, 0, 120)
splash.Position = UDim2.new(0.5, -180, 0.15, 0)
splash.BackgroundColor3 = Color3.fromRGB(0,0,0)
splash.ZIndex = 10005
splash.AnchorPoint = Vector2.new(0.5, 0)
Instance.new("UICorner", splash)
local sLabel = Instance.new("TextLabel", splash)
sLabel.Size = UDim2.new(1,0,1,0)
sLabel.BackgroundTransparency = 1
sLabel.Text = "NX2"
sLabel.TextColor3 = Color3.fromRGB(0,255,127)
sLabel.Font = Enum.Font.SourceSansBold
sLabel.TextScaled = true
sLabel.ZIndex = 10006

task.spawn(function()
    task.wait(2)
    if splash and splash.Parent then
        pcall(function() splash:Destroy() end)
    end
end)

-- --------- واجهة START (مع عنوان NX2 فوق START باللون الأصفر) ---------
local startFrame = Instance.new("Frame", sg)
startFrame.Name = "StartFrame"
startFrame.Size = UDim2.new(0, 300, 0, 180)
startFrame.Position = UDim2.new(0.5, -150, 0.45, -90)
startFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
startFrame.ZIndex = 900
Instance.new("UICorner", startFrame)
local stroke = Instance.new("UIStroke", startFrame)
stroke.Color = Color3.fromRGB(0, 170, 255)

-- عنوان NX2 فوق زر START
local startTitle = Instance.new("TextLabel", startFrame)
startTitle.Size = UDim2.new(1, 0, 0, 40)
startTitle.Position = UDim2.new(0, 0, 0, 8)
startTitle.BackgroundTransparency = 1
startTitle.Text = "NX2"
startTitle.TextColor3 = Color3.fromRGB(255, 255, 0) -- أصفر
startTitle.Font = Enum.Font.SourceSansBold
startTitle.TextScaled = true
startTitle.ZIndex = 902

local sBtn = Instance.new("TextButton", startFrame)
sBtn.Size = UDim2.new(0.6, 0, 0, 50)
sBtn.Position = UDim2.new(0.2, 0, 0.45, 0)
sBtn.BackgroundColor3 = Color3.fromRGB(0, 180, 0)
sBtn.Text = "START"
sBtn.TextColor3 = Color3.new(1, 1, 1)
sBtn.TextSize = 22
sBtn.Font = Enum.Font.SourceSansBold
sBtn.ZIndex = 901
Instance.new("UICorner", sBtn)

-- --------- القائمة الرئيسية (غير قابلة للسحب كما طلبت) ---------
local main = Instance.new("Frame", sg)
main.Name = "MainFrame"
main.Size = UDim2.new(0, 380, 0, 460)
main.Position = UDim2.new(0.5, -190, 0.55, -230)
main.BackgroundColor3 = Color3.fromRGB(10, 10, 10)
main.Visible = false
main.ZIndex = 900
main.Draggable = false -- غير قابلة للسحب
Instance.new("UICorner", main)
local mainStroke = Instance.new("UIStroke", main)
mainStroke.Color = Color3.fromRGB(255, 255, 0)

local p1 = Instance.new("Frame", main); p1.Size = UDim2.new(1,0,1,-100); p1.Position = UDim2.new(0,0,0,100); p1.BackgroundTransparency = 1
local p2 = Instance.new("Frame", main); p2.Size = p1.Size; p2.Position = p1.Position; p2.BackgroundTransparency = 1; p2.Visible = false

local function tab(t, x)
    local b = Instance.new("TextButton", main)
    b.Size = UDim2.new(0.5,0,0,40); b.Position = UDim2.new(x,0,0,40); b.Text = t
    b.BackgroundColor3 = Color3.fromRGB(30,30,30); b.TextColor3 = Color3.new(1,1,1)
    return b
end
local b1 = tab("اللعب", 0); local b2 = tab("الشخصية", 0.5)
b1.MouseButton1Click:Connect(function() p1.Visible = true; p2.Visible = false end)
b2.MouseButton1Click:Connect(function() p1.Visible = false; p2.Visible = true end)

local function btn(t, y, p)
    local b = Instance.new("TextButton", p)
    b.Size = UDim2.new(0.9,0,0,36); b.Position = UDim2.new(0.05,0,y,0)
    b.BackgroundColor3 = Color3.fromRGB(40,40,40); b.Text = t; b.TextColor3 = Color3.new(1,1,1)
    Instance.new("UICorner", b)
    return b
end

-- أزرار
local aim = btn("Aimbot: OFF", 0.05, p1)
local aimAlt = btn("Aimbot Circle 2: OFF", 0.13, p1) -- زر ثاني للأيم
local copyDisc = btn("سيرفر ديسكورد ل سكربتات زياده!", 0.21, p1) -- كما طلبت تحت الأيم في تبويب اللعب

local speed = btn("Speed 4 (Safe): OFF", 0.05, p2)
local jump = btn("Jump 3.5: OFF", 0.2, p2)
local noclip = btn("Noclip (الاختراق): OFF", 0.35, p2)
local hideBtn = btn("إخفاء القائمة", 0.55, p2)
local removeScriptBtn = btn("إغلاق السكربت نهائياً", 0.9, p2)

-- START سلوك التحميل 1.5 ثانية ثم إظهار القائمة
sBtn.MouseButton1Click:Connect(function()
    sBtn.Text = "START..."
    sBtn.BackgroundColor3 = Color3.fromRGB(200, 200, 0)
    task.wait(1.5) -- تحميل لمدة ثانية ونص كما طلبت
    startFrame.Visible = false
    main.Visible = true
    toggleBtn.Text = "إخفاء"
end)

toggleBtn.MouseButton1Click:Connect(function()
    main.Visible = not main.Visible
    toggleBtn.Text = main.Visible and "إخفاء" or "فتح"
end)

-- زر شيل القائمة فوق السكربت (ينهي الواجهة بسرعة)
local function restoreCharacterParts(ch)
    if not ch then return end
    for _, v in pairs(ch:GetDescendants()) do
        if v:IsA("BasePart") then
            pcall(function() v.CanCollide = true end)
        end
    end
    local hum = ch:FindFirstChildOfClass("Humanoid")
    if hum then
        pcall(function()
            hum.WalkSpeed = defaultWalkSpeed
            if hum.JumpPower and hum.UseJumpPower then
                hum.JumpPower = defaultJumpPower
            else
                hum.JumpPower = defaultJumpPower
            end
        end)
    end
end

local heartbeatConn, characterAddedConn
local function cleanup()
    -- فصل جميع الاتصالات
    if heartbeatConn then heartbeatConn:Disconnect(); heartbeatConn = nil end
    for _, c in ipairs(connections) do
        if c and c.Connected then pcall(function() c:Disconnect() end) end
    end
    connections = {}

    -- إزالة ESPs
    for pl, gui in pairs(espGuis) do
        if gui and gui.Parent then pcall(function() gui:Destroy() end) end
    end
    espGuis = {}

    -- إزالة خط الأيم إن وُجد
    if _G.__NX2_aimLine and type(_G.__NX2_aimLine.Destroy) == "function" then
        pcall(function() _G.__NX2_aimLine:Destroy() end)
        _G.__NX2_aimLine = nil
    end

    -- إعادة القيم على الشخصية الحالية
    if player.Character then restoreCharacterParts(player.Character) end
    if characterAddedConn then characterAddedConn:Disconnect(); characterAddedConn = nil end

    -- تدمير الواجهة
    if sg and sg.Parent then pcall(function() sg:Destroy() end) end
    print("NX2: Script removed and cleaned up.")
end

closeBtn.MouseButton1Click:Connect(function() cleanup() end)
removeScriptBtn.MouseButton1Click:Connect(function() cleanup() end)
topRemoveBtn.MouseButton1Click:Connect(function() cleanup() end)

-- ---------------- دائرتي الأيم (الأول كبير والثاني صغير) ----------------
local fire1 = Instance.new("TextButton", sg)
fire1.Name = "FireCircle1"
fire1.Size = UDim2.new(0, 120, 0, 120) -- أكبر
fire1.Position = UDim2.new(0.75, 0, 0.55, 0)
fire1.BackgroundColor3 = Color3.new(0,0,0)
fire1.Text = "FIRE\nNX2"
fire1.TextColor3 = Color3.new(1,1,1)
fire1.Font = Enum.Font.SourceSansBold
fire1.Visible = false
fire1.Draggable = true -- الدائرة قابلة للسحب
fire1.TextScaled = true -- تكبير الاسم داخل الدائرة
Instance.new("UICorner", fire1).CornerRadius = UDim.new(1, 0)
Instance.new("UIStroke", fire1).Color = Color3.new(1,0,0)

local fire2 = Instance.new("TextButton", sg)
fire2.Name = "FireCircle2"
fire2.Size = UDim2.new(0, 80, 0, 80)
fire2.Position = UDim2.new(0.85, 0, 0.65, 0)
fire2.BackgroundColor3 = Color3.fromRGB(10,10,10)
fire2.Text = "F2"
fire2.TextColor3 = Color3.fromRGB(0,255,127)
fire2.Font = Enum.Font.SourceSansBold
fire2.Visible = false
fire2.Draggable = true
fire2.TextScaled = true
Instance.new("UICorner", fire2).CornerRadius = UDim.new(1, 0)
Instance.new("UIStroke", fire2).Color = Color3.fromRGB(0,255,127)

aim.MouseButton1Click:Connect(function()
    fire1.Visible = not fire1.Visible
    aim.Text = fire1.Visible and "Aimbot: ON" or "Aimbot: OFF"
end)

aimAlt.MouseButton1Click:Connect(function()
    fire2.Visible = not fire2.Visible
    aimAlt.Text = fire2.Visible and "Aimbot Circle 2: ON" or "Aimbot Circle 2: OFF"
end)

-- ---------------- حالات السرعة والقفز وnoclip ----------------
speed.MouseButton1Click:Connect(function() sOn = not sOn; speed.Text = sOn and "Speed: ON" or "Speed: OFF" end)
jump.MouseButton1Click:Connect(function() jOn = not jOn; jump.Text = jOn and "Jump: ON" or "Jump: OFF" end)
noclip.MouseButton1Click:Connect(function() nOn = not nOn; noclip.Text = nOn and "Noclip: ON" or "Noclip: OFF" end)
copyDisc.MouseButton1Click:Connect(function() pcall(setclipboard, "https://discord.gg/syPpUv8Jf") end)
hideBtn.MouseButton1Click:Connect(function() main.Visible = false; toggleBtn.Text = "فتح" end)

-- ---------------- ESP: كشف اللاعبين باللون الأخضر ----------------
local function createESPForPlayer(plr)
    if not plr or plr == player then return end
    if espGuis[plr] and espGuis[plr].Parent then return end

    local function attachToCharacter(ch)
        if not ch then return end
        local hrp = ch:FindFirstChild("HumanoidRootPart") or ch:FindFirstChild("Head")
        if not hrp then return end
        local bg = Instance.new("BillboardGui")
        bg.Name = "NX2_ESP_"..plr.Name
        bg.Size = UDim2.new(0,140,0,48)
        bg.Adornee = hrp
        bg.AlwaysOnTop = true
        bg.StudsOffset = Vector3.new(0, 2.5, 0)
        bg.Parent = sg

        local label = Instance.new("TextLabel", bg)
        label.Size = UDim2.new(1,0,1,0)
        label.BackgroundTransparency = 1
        label.Text = plr.Name
        label.TextColor3 = Color3.fromRGB(0,255,0)
        label.TextStrokeTransparency = 0
        label.Font = Enum.Font.SourceSansBold
        label.TextScaled = true

        espGuis[plr] = bg
    end

    if plr.Character then
        attachToCharacter(plr.Character)
    end

    -- تحد��ث عند إعادة التوليد
    local chConn
    chConn = plr.CharacterAdded:Connect(function(ch)
        task.wait(0.3)
        if espGuis[plr] and espGuis[plr].Parent then
            pcall(function() espGuis[plr]:Destroy() end)
        end
        attachToCharacter(ch)
    end)
    table.insert(connections, chConn)
end

local function removeESPForPlayer(plr)
    if espGuis[plr] then
        pcall(function() espGuis[plr]:Destroy() end)
        espGuis[plr] = nil
    end
end

for _, pl in pairs(Players:GetPlayers()) do
    if pl ~= player then createESPForPlayer(pl) end
end

local playerAddedConn = Players.PlayerAdded:Connect(function(pl)
    createESPForPlayer(pl)
end)
local playerRemovingConn = Players.PlayerRemoving:Connect(function(pl)
    removeESPForPlayer(pl)
end)
table.insert(connections, playerAddedConn)
table.insert(connections, playerRemovingConn)

-- ---------------- خط الأيم الأحمر عند الاستهداف (Drawing إن توفرت) ----------------
local drawAvailable, aimLine = false, nil
pcall(function()
    if Drawing and Drawing.new then
        aimLine = Drawing.new("Line")
        aimLine.Color = Color3.fromRGB(255, 0, 0)
        aimLine.Thickness = 2
        aimLine.Visible = false
        drawAvailable = true
        _G.__NX2_aimLine = aimLine
    end
end)

local function getTargetFromMouse()
    local targetPart = nil
    local mouse = player:GetMouse()
    if mouse then
        targetPart = mouse.Target
    end
    if not targetPart then return nil end
    local char = targetPart:FindFirstAncestorOfClass("Model")
    if not char then char = targetPart.Parent end
    if char and char:FindFirstChildOfClass("Humanoid") then
        return Players:GetPlayerFromCharacter(char)
    end
    return nil
end

-- تحديث الرسم كل إطار (RenderStepped)
local renderConn
renderConn = RunService.RenderStepped:Connect(function()
    if not drawAvailable or not aimLine then return end
    local activeAim = fire1.Visible or fire2.Visible
    if not activeAim then
        aimLine.Visible = false
        return
    end

    local targetPlayer = getTargetFromMouse()
    if targetPlayer and targetPlayer.Character then
        local targetRoot = targetPlayer.Character:FindFirstChild("Head") or targetPlayer.Character:FindFirstChild("HumanoidRootPart")
        if targetRoot and Camera then
            local pos, onScreen = Camera:WorldToViewportPoint(targetRoot.Position)
            if onScreen then
                local from = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
                local to = Vector2.new(pos.X, pos.Y)
                aimLine.From = from
                aimLine.To = to
                aimLine.Color = Color3.fromRGB(255, 0, 0)
                aimLine.Visible = true
                return
            end
        end
    end
    aimLine.Visible = false
end)
table.insert(connections, renderConn)

-- ---------------- حلقة Heartbeat لتطبيق التأثيرات ----------------
heartbeatConn = RunService.Heartbeat:Connect(function()
    if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then return end
    local hrp = player.Character:FindFirstChild("HumanoidRootPart")
    local hum = player.Character:FindFirstChildOfClass("Humanoid")
    if not hrp or not hum then return end

    if sOn and hum.MoveDirection.Magnitude > 0 then
        hrp.Velocity = Vector3.new(hum.MoveDirection.X * 45, hrp.Velocity.Y, hum.MoveDirection.Z * 45)
    end

    if jOn then pcall(function() hum.JumpPower = 100 end) end

    if nOn then
        for _, v in pairs(player.Character:GetDescendants()) do
            if v:IsA("BasePart") then
                pcall(function() v.CanCollide = false end)
            end
        end
    end
end)
table.insert(connections, heartbeatConn)

-- تحديث ESP عند إعادة توليد الشخصية للاعب المحلي
characterAddedConn = player.CharacterAdded:Connect(function(ch)
    task.wait(0.5)
    cacheDefaults()
    for pl, gui in pairs(espGuis) do
        pcall(function()
            if gui and gui.Parent and pl.Character then
                local hrp = pl.Character:FindFirstChild("HumanoidRootPart") or pl.Character:FindFirstChild("Head")
                if hrp then gui.Adornee = hrp end
            end
        end)
    end
end)
table.insert(connections, characterAddedConn)

-- تنبيه للمستخدم
print("NX2 loaded. الشريط العلوي ظاهر دائماً باللون الأصفر. زر 'شيل القائمة' فوق السكربت يحذف الواجهة فوراً. اضغط START للتحميل ثم فتح القائمة.")